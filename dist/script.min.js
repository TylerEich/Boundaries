/*
 Boundaries v1.0.0
 (c) 2013-2014 Tyler Eich https://github.com/TylerEich/Boundaries
 License: MIT
*/
"use strict";angular.module("bndry.action",[]).controller("ActionCtrl",["$rootScope","$scope","HistorySvc",function(e,t,n){t.clear=function(){e.$broadcast("action:clear"),n.clear()},t.undo=function(){n.hasUndo()&&n.undo()},t.redo=function(){n.hasRedo()&&n.redo()}}]),angular.module("bndry.color",[]).service("ColorSvc",function(){function e(){for(var e=1,t=0,n=arguments.length;n>e;e++)arguments[t]>arguments[e]&&(t=e);return arguments[t]}function t(){for(var e=1,t=0,n=arguments.length;n>e;e++)arguments[e]>arguments[t]&&(t=e);return arguments[t]}function n(e,t,n,o){return e=Math.round(255*e),t=Math.round(255*t),n=Math.round(255*n),o=Math.round(255*o),(e<<24|t<<16|n<<8|o)>>>0}var o={},r=this;this.convert={rgba:function(e){return o=n(e.r,e.g,e.b,e.a),r},hsla:function(e){var t,a=e,i=a.h,c=a.s,l=a.l,s=a.a;return i*=6,t=[l+=c*=.5>l?l:1-l,l-i%1*c*2,l-=c*=2,l,l+i%1*c,l+c],o=n(t[~~i%6],t[(16|i)%6],t[(8|i)%6],s),r},hex24:function(e){return r.convert.hex32(e+"FF"),r},hex32:function(e){return o=parseInt(e,16)>>>0,r}},this.to={rgba:function(){var e=(o>>24&255)/255,t=(o>>16&255)/255,n=(o>>8&255)/255,r=(255&o)/255;return o=0,{r:e,g:t,b:n,a:r}},hsla:function(){var n,o,a,i=r.to.rgba(),c=i,l=c.r,s=c.g,u=c.b,d=c.a,g=e(l,s,u),p=t(l,s,u),f=p-g;return n=o=a=(p+g)/2,p===g?n=o=0:(n=l===p?(s-u)/f%6:s===p?(u-l)/f+2:(l-s)/f+4,n/=6),{h:n,s:o,l:a,a:d}},hex24:function(){return r.to.hex32().substring(0,6)},hex32:function(){var e=o.toString(16);return o=0,("00000000"+e).slice(-8)}}}).controller("ColorCtrl",["$scope","$localStorage","ColorSvc",function(e,t,n){e.$storage=t.$default({colors:[{r:1,g:0,b:0,a:.125,weight:10},{r:0,g:1,b:0,a:.125,weight:10},{r:0,g:0,b:1,a:.125,weight:10}],activeColor:1}),e.fillColor=function(t){var o=e.$storage.colors[t];return"#"+n.convert.rgba(o).to.hex24()}}]),angular.module("bndry.drawing",["ngStorage","bndry.map","bndry.color","bndry.history"]).service("DirectionsSvc",["$q","MapSvc",function(e,t){var n=this,o=new t.DirectionsService;n.route=function(n){function r(e){o.route(a,function(n,o){if(o===t.DirectionsStatus.OK){var a=n.routes[0].overview_path;i.resolve(a)}else o===t.DirectionsStatus.UNKNOWN_ERROR&&3>e?(e++,r(e)):i.reject()},function(){3>e?(e++,r(e)):i.reject()})}if(2!==n.length)return console.error("Requires exactly 2 locations."),!1;var a={origin:n[0],destination:n[1],travelMode:t.TravelMode.DRIVING},i=e.defer();return r(0),i.promise}}]).service("DrawingSvc",["$rootScope","$q","$localStorage","DirectionsSvc","MapSvc","ColorSvc",function(e,t,n,o,r,a){function i(){var e=g.drawings[g.drawings.length-1];console.info("Index of last node:",e.nodes[e.nodes.length-1].index),console.info("Length of path:",e._poly.getPath().getLength())}function c(e){return"rgba("+100*e.r+"%,"+100*e.g+"%,"+100*e.b+"%,"+e.a+")"}function l(e,t,n){for(var o=g.drawings[e],r=t;r<o.nodes.length;r++){var a=o.nodes[r];a.index+=n}}function s(e){return{path:r.SymbolPath.CIRCLE,scale:10,strokeColor:"#"+a.convert.rgba(e).to.hex24(),strokeOpacity:1,strokeWeight:2.5}}function u(e,t){return{clickable:!0,crossOnDrag:!1,cursor:"pointer",draggable:!0,flat:!0,icon:s(e),map:r.map,position:t}}function d(e,t){var n={clickable:!0,draggable:!1,editable:!1,map:r.map};return t?(n.fillColor=c(e),n.strokeWeight=0):(n.strokeColor=c(e),n.strokeWeight=e.weight),n}var g=this;g.makePath=function(e,n){var r=t.defer();return n?r.resolve(e):o.route(e).then(r.resolve),r.promise},g.splicePath=function(e,t,n,o){var r=[t,n];return o&&(r=r.concat(o)),Array.prototype.splice.apply(e,r)},g.makeNode=function(e,t){var o=n.colors[e],a=new r.Marker(u(o,t));return{lat:t.lat(),lng:t.lng(),index:null,_marker:a}},g.spliceNode=function(e,n,o,a){void 0===o&&(o=g.drawings[e].nodes.length);var c=g.drawings[e],s=[n,o];a&&(a._marker.setMap(r.map),s=s.concat(a));var u,d,p,f=Array.prototype.splice.apply(c.nodes,s);if(d=c.nodes[n],n>=1&&n-1<c.nodes.length&&(u=c.nodes[n-1]),n>=0&&n+1<c.nodes.length&&(p=c.nodes[n+1]),f.length>0){var h=c._poly,v=h.getPath().getArray(),m=(u?u.index:-1)+1,y=p?p.index:f[f.length-1].index+1,b=y-m;g.splicePath(v,m,b),h.setPath(v),d&&(d.index=u?u.index:0),l(e,n+1,-b)}for(var w=0;w<f.length;w++)f[w]._marker.setMap(null);var S,$,T,M,C=[];d&&($=new r.LatLng(d.lat,d.lng),u&&(T=new r.LatLng(u.lat,u.lng),S=g.makePath([T,$],c.rigid).then(function(e){return d.index=u.index,e}),C.push(S)),p&&(M=new r.LatLng(p.lat,p.lng),C.push(g.makePath([$,M],c.rigid))),u||p||C.push(g.makePath([$,$],c.rigid)),t.all(C).then(function(t){var o,r,s,d,f=c._poly.getPath().getArray(),h=0;2===t.length&&t[1].shift(),u?(r=t[0],r.shift(),l(e,n,r.length),h=u.index+1,d=r[r.length-1]):a.index=0,p&&(s=t[t.length-1],s.pop(),l(e,n+1,s.length),d=d||s[0]),u||p||(d=t[0][0]),o=Array.prototype.concat.apply([],t),g.splicePath(f,h,0,o),a._marker.setPosition(d),c._poly.setPath(f),i()}))},g.makeDrawing=function(e,t,o){var a,i=n.colors[e];return a=o?new r.Polygon(d(i,o)):new r.Polyline(d(i,o)),{colorIndex:e,rigid:t,fill:o,_poly:a,nodes:[]}},g.spliceDrawing=function(e,t,n){void 0===t&&(t=g.drawings.length),console.log(t,n);var o=g.drawings.slice(e,e+t);for(var r in o)o[r]._poly.setMap(null),g.spliceNode(r,0);Array.prototype.splice.apply(g.drawings,arguments)},g.drawings=[]}]).controller("DrawingCtrl",["$scope","$localStorage","DrawingSvc","HistorySvc",function(e,t,n,o){function r(t,r){var a=e.$storage.activeColor,c=!1,l=!1,s=i();if(s){var u=n.makeDrawing(a,c,l);n.spliceDrawing(n.drawings.length,0,u)}var d=n.drawings.length-1,g=n.drawings[d].nodes.length,p=n.makeNode(a,r.latLng);n.spliceNode(d,g,0,p),o.add({undo:function(e,t,o){console.log("Undo:",n.drawings),n.spliceNode(e,t,1),o&&n.spliceDrawing(e,1)}.bind(null,d,g,s),redo:function(e,t,o){n.spliceNode(e,t,0,o)}.bind(null,d,g,p)})}function a(e,t,r){var a=e[0],i=n.drawings[t].colorIndex,c=n.drawings[t].nodes[r],l=n.makeNode(i,a.latLng);n.spliceNode(t,r,1,l),o.add({undo:function(e,t,o){n.spliceNode(e,t,1,o)}.bind(null,t,r,c),redo:function(e,t,o){n.spliceNode(e,t,1,o)}.bind(null,t,r,l)})}function i(){if(0===n.drawings.length)return!0;var t=n.drawings[n.drawings.length-1];return t&&t.colorIndex!==e.$storage.activeColor}e.$storage=t.$default({rigid:!1,colors:[{r:1,g:0,b:0,a:.125,weight:10},{r:0,g:1,b:0,a:.125,weight:10},{r:0,g:0,b:1,a:.125,weight:10}],activeColor:1}),e.drawings=n.drawings,e.$on("map:click",r),e.$on("action:clear",function(){n.spliceDrawing(0)}),e.marker={click:function(e){r(void 0,e[0])},dragend:a},e.poly={click:function(){}}}]),angular.module("bndry.geo",["bndry.map"]).service("GeolocationSvc",["$q",function(e){this.getLocation=function(){var t=e.defer();return"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){t.resolve(e)},function(e){t.reject(e)}):t.reject(!1),t.promise}}]).service("GeocodeSvc",["$q","MapSvc",function(e,t){this.geocode=function(n){var o=new t.Geocoder,r=e.defer();return o.geocode({location:n},function(e,n){n===t.GeocoderStatus.OK?r.resolve(e):r.reject(n)}),r.promise}}]),angular.module("bndry.history",[]).service("HistorySvc",function(){var e,t,n=[],o=-1,r=!1;return t=function(e,t){return e&&"function"==typeof e[t]?(r=!0,e[t](),r=!1,this):this},{add:function(t){return r?this:(n.splice(o+1,n.length-o),n.push(t),o=n.length-1,e&&e(),this)},setCallback:function(t){e=t},undo:function(){var r=n[o];return r?(t(r,"undo"),o-=1,e&&e(),this):this},redo:function(){var r=n[o+1];return r?(t(r,"redo"),o+=1,e&&e(),this):this},clear:function(){var t=n.length;n=[],o=-1,e&&t>0&&e()},hasUndo:function(){return-1!==o},hasRedo:function(){return o<n.length-1},getCommands:function(){return n}}}),angular.module("bndry.image",["ngStorage","bndry.map","bndry.drawing","bndry.color"]).service("ImageSvc",["$localStorage","MapSvc","DrawingSvc","ColorSvc",function(e,t,n,o){this.pxSize=function(t,n){var o=e.width/e.height;return{ratio:o,width:o>=1?t:Math.round(o*t),height:1>o?n:Math.round(1/o*n)}},this.generateUrl=function(){if(n.drawings){var r,a,i,c,l,s,u,d="https://maps.googleapis.com/maps/api/staticmap",g=[],p=this.pxSize(640,640);for(r=0;r<e.style.length;r++){i=e.style[r],c=[],"featureType"in i&&"all"!==i.featureType&&c.push("feature:"+i.featureType),"elementType"in i&&"all"!==i.elementType&&c.push("element:"+i.elementType);for(a=0;a<i.stylers.length;a++){l=i.stylers[a];for(s in l)u=l[s],"color"===s&&(u="0x"+u.substring(1)),c.push(s+":"+u)}c=c.join("|"),""!==c&&g.push("style="+c)}var f,h,v,m,y,b,w=new t.LatLngBounds;for(r=0;r<n.drawings.length;r++){for(h=[],f=n.drawings[r],v=f._poly.getPath().getArray(),a=0;a<v.length;a++)w.extend(v[a]);m=t.geometry.encoding.encodePath(v),y=e.colors[f.activeColor],b="0x"+o.convert.hex24().toHex(y.rgba),f.polygon?h.push("fillcolor:"+b):(h.push("color:"+b),h.push("weight:"+y.weight)),h.push("enc:"+m),h=h.join("|"),h&&g.push("path="+h)}var S=w.getNorthEast(),$=w.getSouthWest(),T=Math.abs(t.computeHeading(S,$)+t.computeHeading(t.southWest,S))/2;return g.push((T>=45&&135>T)==p.ratio>=1?"size="+p.height+"x"+p.width:"size="+p.width+"x"+p.height),g.push("format="+e.format),g.push("scale=2"),g.push("sensor=true"),encodeURI(d+"?"+g.join("&"))}}}]),angular.module("bndry.map",["ngStorage"]).service("MapSvc",["$rootScope",function(e){function t(t){n.map.addListener(t,function(n){e.$broadcast("map:"+t,n)})}var n=this;angular.extend(n,google.maps),n.map=new n.Map(document.getElementById("map_canvas")),n.placesSvc=new n.places.PlacesService(n.map),n.autocompleteSvc=new n.places.AutocompleteService;var o=["bounds_changed","center_changed","click","dblclick","drag","dragend","dragstart","heading_changed","idle","maptypeid_changed","mousemove","mouseout","mouseover","projection_changed","resize","rightclick","tilesloaded","tilt_changed","zoom_changed"];o.forEach(t)}]).controller("MapCtrl",["$scope","$rootScope","$localStorage","MapSvc",function(e,t,n,o){n.$default({lat:0,lng:0,zoom:10,mapTypeId:o.MapTypeId.ROADMAP,style:[{stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"on"},{color:"#ffffff"}]},{featureType:"road",stylers:[{visibility:"on"}]},{elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#808080"}]},{elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{elementType:"labels.text.fill",stylers:[{color:"#000000"}]},{featureType:"water",stylers:[{visibility:"on"},{color:"#40bfbf"}]},{featureType:"water",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#dfdfdf"}]},{featureType:"road.local",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",stylers:[{visibility:"off"}]}]}),e.$on("map:idle",function(){var e=o.map.getCenter(),t=o.map.getZoom();n.lat=e.lat(),n.lng=e.lng(),n.zoom=t}),e.$on("map:maptypeid_changed",function(){var e=o.map.getMapTypeId();n.mapTypeId=e});var r={center:new o.LatLng(n.lat,n.lng),disableDefaultUI:!0,disableDoubleClickZoom:!0,draggableCursor:"crosshair",draggingCursor:"move",mapTypeId:n.mapTypeId,mapTypeControl:!0,mapTypeControlOptions:{mapTypeIds:[o.MapTypeId.ROADMAP,o.MapTypeId.HYBRID,"custom"]},scaleControl:!0,zoom:n.zoom};o.map.setOptions(r);var a=new o.StyledMapType(n.style,{name:"Custom"});o.map.mapTypes.set("custom",a)}]).controller("MapActionCtrl",["$scope","MapSvc",function(e,t){e.setMapTypeId=function(e){e in t.MapTypeId&&(console.log(e,"in MapSvc.mapTypeId"),e=t.MapTypeId[e]),t.map.setMapTypeId(e)}}]),angular.module("bndry.mode",[]).controller("ModeCtrl",["$scope",function(e){e.rigid=!1,e.polygon=!1}]),angular.module("bndry.search",["ngSanitize","bndry.map"]).directive("focusOn",["$parse",function(e){return{restrict:"A",link:function(t,n,o){var r=e(o.focusOn);t.$watch(r,function(e){void 0!==e&&(e?n[0].focus():n[0].blur())})}}}]).service("SearchSvc",["$q","MapSvc",function(e,t){this.search=function(n){var o=e.defer();if(n.length<=0)o.resolve([]);else{var r={input:n};r.bounds=t.map.getBounds(),t.autocompleteSvc.getPlacePredictions(r,function(e,n){n===t.places.PlacesServiceStatus.OK?o.resolve(e):o.reject(n===t.places.PlacesServiceStatus.ZERO_RESULTS?"No Results":"An Error Occurred")})}return o.promise},this.loadPlaceFromReference=function(e){e&&e&&t.placesSvc.getDetails({reference:e},function(e,n){n===t.places.PlacesServiceStatus.OK&&(e.geometry.viewport?t.map.fitBounds(e.geometry.viewport):e.geometry.location&&t.map.panTo(e.geometry.location))})}}]).controller("SearchCtrl",["$scope","$sce","$sessionStorage","SearchSvc",function(e,t,n,o){function r(e){if(e){if(!c)return void(l=e);s=e,c=!1,o.search(e).then(a,i).then(function(){c=!0,l!==s&&(r(l),l="")})}}function a(n){for(var o=0;o<n.length;o++){var r=n[o].description;n[o].description="";for(var a=0,i=0;i<n[o].matched_substrings.length;i++){var c=n[o].matched_substrings[i].offset,l=n[o].matched_substrings[i].length;n[o].description+=r.slice(a,c)+"<b>"+r.substr(c,l)+"</b>",a=c+l}n[o].description+=r.slice(a),n[o].description="<span>"+n[o].description+"</span>",n[o].description=t.trustAsHtml(n[o].description)}e.suggestions=n}function i(n){"string"==typeof n&&(e.suggestions=[{description:t.trustAsHtml("<i>"+n+"</i>"),error:!0}])}var c=!0,l="",s="";e.$tempStorage=n.$default({query:"",active:-1}),e.keydown=function(t){var n=13===t.which,o=38===t.which,r=40===t.which;return n||o||r?(t.preventDefault(),void(e.suggestions[e.$tempStorage.active]&&(n?(e.loadOnMap(e.suggestions[e.$tempStorage.active].reference),e.show.value=""):o&&e.$tempStorage.active>-1?e.$tempStorage.active--:r&&e.$tempStorage.active<e.suggestions.length-1&&e.$tempStorage.active++))):void(e.$tempStorage.active=0)},e.loadOnMap=o.loadPlaceFromReference,e.$watch("$tempStorage.query",r)}]),angular.module("bndry.status",["bndry.map","bndry.geo"]).directive("statusBar",["$interval",function(e){return{restrict:"E",scope:{hide:"@",value:"@"},template:'<div ng-style="{width: value * 100 + \'%\'}" style="height: 100%; position: absolute;" ng-hide="hide"></div>',link:function(t){e(function(){t.value=Math.random()},1e3)}}}]).controller("StatusCtrl",["$scope","$timeout","MapSvc","GeocodeSvc",function(e,t,n,o){var r="";e.locality=function(){return r},e.$on("map:idle",function(){o.geocode(n.map.getCenter()).then(function(e){var t=["administrative_area_level_3","administrative_area_level_2","administrative_area_level_1","country"];r="",e.forEach(function(e){if(!r)for(var n=0;n<t.length;n++)if(e.types.indexOf(t[n])>-1&&(r=e.formatted_address),r)return!1})},function(){r="Unknown Locality"})})}]),angular.module("bndry",["ngTouch","ngStorage","ui.map","ngAnimate","bndry.action","bndry.color","bndry.drawing","bndry.geo","bndry.history","bndry.image","bndry.map","bndry.mode","bndry.search","bndry.status"]).directive("noScroll",function(){return{restrict:"A",link:function(e,t){t.on("touchstart wheel",function(e){e.preventDefault()})}}}).controller("MasterCtrl",["$scope","$localStorage","ColorSvc",function(e,t,n){e.$storage=t,e.fillActiveColor=function(){var t=e.$storage.activeColor,o=e.$storage.colors[t],r=n.convert.rgba(o).to.hex24();return"#"+r},e.show={header:"",footer:""},e.setShowHeader=function(t){e.show.header=e.show.header===t?"":t},e.setShowFooter=function(t){e.show.footer=e.show.footer===t?"":t}}]).run(function(){window.addEventListener("DOMContentLoaded",function(){angular.element(document.querySelector("#splash")).removeClass("loading")},!1),window.addEventListener("orientationchange",function(){window.scrollTo(0,0)})});