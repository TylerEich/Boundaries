/*
 Boundaries v1.0.0
 (c) 2013-2014 Tyler Eich https://github.com/TylerEich/Boundaries
 License: MIT
*/
"use strict";angular.module("bndry.action",[]).controller("ActionCtrl",["$rootScope","$scope","HistorySvc",function(e,t,r){t.clear=function(){e.$broadcast("action:clear"),r.clear()},t.undo=function(){r.hasUndo()&&r.undo()},t.redo=function(){r.hasRedo()&&r.redo()}}]),angular.module("bndry.color",[]).service("ColorSvc",function(){function e(){for(var e=1,t=0,r=arguments.length;r>e;e++)arguments[t]>arguments[e]&&(t=e);return arguments[t]}function t(){for(var e=1,t=0,r=arguments.length;r>e;e++)arguments[e]>arguments[t]&&(t=e);return arguments[t]}function r(e,t,r,n){return e=Math.round(255*e),t=Math.round(255*t),r=Math.round(255*r),n=Math.round(255*n),(e<<24|t<<16|r<<8|n)>>>0}var n={},o=this;this.convert={rgba:function(e){return n=r(e.r,e.g,e.b,e.a),o},hsla:function(e){var t,a=e,i=a.h,c=a.s,l=a.l,s=a.a;return i*=6,t=[l+=c*=.5>l?l:1-l,l-i%1*c*2,l-=c*=2,l,l+i%1*c,l+c],n=r(t[~~i%6],t[(16|i)%6],t[(8|i)%6],s),o},hex24:function(e){return o.convert.hex32(e+"FF"),o},hex32:function(e){return n=parseInt(e,16)>>>0,o}},this.to={rgba:function(){var e=(n>>24&255)/255,t=(n>>16&255)/255,r=(n>>8&255)/255,o=(255&n)/255;return n=0,{r:e,g:t,b:r,a:o}},hsla:function(){var r,n,a,i=o.to.rgba(),c=i,l=c.r,s=c.g,u=c.b,d=c.a,g=e(l,s,u),p=t(l,s,u),f=p-g;return r=n=a=(p+g)/2,p===g?r=n=0:(r=l===p?(s-u)/f%6:s===p?(u-l)/f+2:(l-s)/f+4,r/=6),{h:r,s:n,l:a,a:d}},hex24:function(){return o.to.hex32().substring(0,6)},hex32:function(){var e=n.toString(16);return n=0,("00000000"+e).slice(-8)}}}).controller("ColorCtrl",["$scope","$localStorage","ColorSvc",function(e,t,r){e.$storage=t.$default({colors:[{r:1,g:0,b:0,a:.125,weight:10},{r:0,g:1,b:0,a:.125,weight:10},{r:0,g:0,b:1,a:.125,weight:10}],activeColor:1}),e.fillColor=function(t){var n=e.$storage.colors[t];return"#"+r.convert.rgba(n).to.hex24()}}]),angular.module("bndry.drawing",["ngStorage","bndry.map","bndry.color","bndry.history"]).service("DirectionsSvc",["$q","MapSvc",function(e,t){var r=this,n=new t.DirectionsService;r.route=function(r){function o(e){n.route(a,function(r,n){if(n===t.DirectionsStatus.OK){var a=r.routes[0].overview_path;i.resolve(a)}else n===t.DirectionsStatus.UNKNOWN_ERROR&&3>e?(e++,o(e)):i.reject()},function(){3>e?(e++,o(e)):i.reject()})}if(2!==r.length)return console.error("Requires exactly 2 locations."),!1;var a={origin:r[0],destination:r[1],travelMode:t.TravelMode.DRIVING},i=e.defer();return o(0),i.promise}}]).service("DrawingSvc",["$rootScope","$q","$localStorage","DirectionsSvc","MapSvc","ColorSvc",function(e,t,r,n,o,a){function i(e){return"rgba("+100*e.r+"%,"+100*e.g+"%,"+100*e.b+"%,"+e.a+")"}function c(e,t,r){for(var n=d.drawings[e],o=t;o<n.nodes.length;o++){var a=n.nodes[o];a.index+=r}}function l(e){return{path:o.SymbolPath.CIRCLE,scale:10,strokeColor:"#"+a.convert.rgba(e).to.hex24(),strokeOpacity:1,strokeWeight:2.5}}function s(e,t){return{clickable:!0,crossOnDrag:!1,cursor:"pointer",draggable:!0,flat:!0,icon:l(e),map:o.map,position:t}}function u(e,t){var r={clickable:!0,draggable:!1,editable:!1,map:o.map};return t?(r.fillColor=i(e),r.strokeWeight=0):(r.strokeColor=i(e),r.strokeWeight=e.weight),r}var d=this;d.makePath=function(e,r){var o=t.defer();return r?o.resolve(e):n.route(e).then(o.resolve),o.promise},d.splicePath=function(e,t,r,n){var o=[t,r];return n&&(o=o.concat(n)),Array.prototype.splice.apply(e,o)},d.makeNode=function(e,t){var n=r.colors[e],a=new o.Marker(s(n,t));return{lat:t.lat(),lng:t.lng(),index:null,_marker:a}},d.spliceNode=function(e,r,n,a){void 0===n&&(n=d.drawings[e].nodes.length);var i=d.drawings[e],l=[r,n];a&&(a._marker.setMap(o.map),l=l.concat(a));var s,u,g,p=Array.prototype.splice.apply(i.nodes,l);if(u=i.nodes[r],r>=1&&r-1<i.nodes.length&&(s=i.nodes[r-1]),r>=0&&r+1<i.nodes.length&&(g=i.nodes[r+1]),p.length>0){var f=i._poly,h=f.getPath().getArray(),v=(s?s.index:-1)+1,m=g?g.index:p[p.length-1].index+1,y=m-v;d.splicePath(h,v,y),f.setPath(h),u&&(u.index=s?s.index:0),c(e,r+1,-y)}for(var b=0;b<p.length;b++)p[b]._marker.setMap(null);var w,S,$,T,M=[];u&&(S=new o.LatLng(u.lat,u.lng),s&&($=new o.LatLng(s.lat,s.lng),w=d.makePath([$,S],i.rigid).then(function(e){return u.index=s.index,e}),M.push(w)),g&&(T=new o.LatLng(g.lat,g.lng),M.push(d.makePath([S,T],i.rigid))),s||g||M.push(d.makePath([S,S],i.rigid)),t.all(M).then(function(t){var n,o,l,u,p=i._poly.getPath().getArray(),f=0;2===t.length&&t[1].shift(),s?(o=t[0],o.shift(),c(e,r,o.length),f=s.index+1,u=o[o.length-1]):a.index=0,g&&(l=t[t.length-1],l.pop(),c(e,r+1,l.length),u=u||l[0]),s||g||(u=t[0][0]),n=Array.prototype.concat.apply([],t),d.splicePath(p,f,0,n),a._marker.setPosition(u),i._poly.setPath(p)}))},d.makeDrawing=function(e,t,n){var a,i=r.colors[e];return a=n?new o.Polygon(u(i,n)):new o.Polyline(u(i,n)),{colorIndex:e,rigid:t,fill:n,_poly:a,nodes:[]}},d.spliceDrawing=function(e,t,r){void 0===t&&(t=d.drawings.length);var n=d.drawings.slice(e,e+t);for(var o in n)n[o]._poly.setMap(null),d.spliceNode(o,0);var a=[e,t];r&&a.push(r),Array.prototype.splice.apply(d.drawings,a)},d.drawings=[]}]).controller("DrawingCtrl",["$scope","$localStorage","DrawingSvc","HistorySvc",function(e,t,r,n){function o(t,o){var a=e.$storage.activeColor,c=!1,l=!1,s=i();if(s){var u=r.makeDrawing(a,c,l);r.spliceDrawing(r.drawings.length,0,u)}var d=r.drawings.length-1,g=r.drawings[d].nodes.length,p=r.makeNode(a,o.latLng);r.spliceNode(d,g,0,p),n.add({undo:function(e,t,n){r.spliceNode(e,t,1),n&&r.spliceDrawing(e,1)}.bind(null,d,g,s),redo:function(e,t,n){r.spliceNode(e,t,0,n)}.bind(null,d,g,p)})}function a(e,t,o){var a=e[0],i=r.drawings[t].colorIndex,c=r.drawings[t].nodes[o],l=r.makeNode(i,a.latLng);r.spliceNode(t,o,1,l),n.add({undo:function(e,t,n){r.spliceNode(e,t,1,n)}.bind(null,t,o,c),redo:function(e,t,n){r.spliceNode(e,t,1,n)}.bind(null,t,o,l)})}function i(){if(0===r.drawings.length)return!0;var t=r.drawings[r.drawings.length-1];return t&&t.colorIndex!==e.$storage.activeColor}e.$storage=t.$default({rigid:!1,colors:[{r:1,g:0,b:0,a:.125,weight:10},{r:0,g:1,b:0,a:.125,weight:10},{r:0,g:0,b:1,a:.125,weight:10}],activeColor:1}),e.drawings=r.drawings,e.$on("map:click",o),e.$on("action:clear",function(){r.spliceDrawing(0)}),e.marker={click:function(e){o(void 0,e[0])},dragend:a},e.poly={click:function(){}}}]),angular.module("bndry.geo",["bndry.map"]).service("GeolocationSvc",["$q",function(e){this.getLocation=function(){var t=e.defer();return"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){t.resolve(e)},function(e){t.reject(e)}):t.reject(!1),t.promise}}]).service("GeocodeSvc",["$q","MapSvc",function(e,t){this.geocode=function(r){var n=new t.Geocoder,o=e.defer();return n.geocode({location:r},function(e,r){r===t.GeocoderStatus.OK?o.resolve(e):o.reject(r)}),o.promise}}]),angular.module("bndry.history",[]).service("HistorySvc",function(){var e,t,r=[],n=-1,o=!1;return t=function(e,t){return e&&"function"==typeof e[t]?(o=!0,e[t](),o=!1,this):this},{add:function(t){return o?this:(r.splice(n+1,r.length-n),r.push(t),n=r.length-1,e&&e(),this)},setCallback:function(t){e=t},undo:function(){var o=r[n];return o?(t(o,"undo"),n-=1,e&&e(),this):this},redo:function(){var o=r[n+1];return o?(t(o,"redo"),n+=1,e&&e(),this):this},clear:function(){var t=r.length;r=[],n=-1,e&&t>0&&e()},hasUndo:function(){return-1!==n},hasRedo:function(){return n<r.length-1},getCommands:function(){return r}}}),angular.module("bndry.image",["ngStorage","bndry.map","bndry.drawing","bndry.color"]).service("ImageSvc",["$localStorage","MapSvc","DrawingSvc","ColorSvc",function(e,t,r,n){this.pxSize=function(t,r){var n=e.width/e.height;return{ratio:n,width:n>=1?t:Math.round(n*t),height:1>n?r:Math.round(1/n*r)}},this.generateUrl=function(){if(r.drawings){var o,a,i,c,l,s,u,d="https://maps.googleapis.com/maps/api/staticmap",g=[],p=this.pxSize(640,640);for(o=0;o<e.style.length;o++){i=e.style[o],c=[],"featureType"in i&&"all"!==i.featureType&&c.push("feature:"+i.featureType),"elementType"in i&&"all"!==i.elementType&&c.push("element:"+i.elementType);for(a=0;a<i.stylers.length;a++){l=i.stylers[a];for(s in l)u=l[s],"color"===s&&(u="0x"+u.substring(1)),c.push(s+":"+u)}c=c.join("|"),""!==c&&g.push("style="+c)}var f,h,v,m,y,b,w=new t.LatLngBounds;for(o=0;o<r.drawings.length;o++){for(h=[],f=r.drawings[o],v=f._poly.getPath().getArray(),a=0;a<v.length;a++)w.extend(v[a]);m=t.geometry.encoding.encodePath(v),y=e.colors[f.activeColor],b="0x"+n.convert.hex24().toHex(y.rgba),f.polygon?h.push("fillcolor:"+b):(h.push("color:"+b),h.push("weight:"+y.weight)),h.push("enc:"+m),h=h.join("|"),h&&g.push("path="+h)}var S=w.getNorthEast(),$=w.getSouthWest(),T=Math.abs(t.computeHeading(S,$)+t.computeHeading(t.southWest,S))/2;return g.push((T>=45&&135>T)==p.ratio>=1?"size="+p.height+"x"+p.width:"size="+p.width+"x"+p.height),g.push("format="+e.format),g.push("scale=2"),g.push("sensor=true"),encodeURI(d+"?"+g.join("&"))}}}]),angular.module("bndry.map",["ngStorage"]).service("MapSvc",["$rootScope",function(e){function t(t){r.map.addListener(t,function(r){e.$broadcast("map:"+t,r)})}var r=this;angular.extend(r,google.maps),r.map=new r.Map(document.getElementById("map_canvas")),r.placesSvc=new r.places.PlacesService(r.map),r.autocompleteSvc=new r.places.AutocompleteService;var n=["bounds_changed","center_changed","click","dblclick","drag","dragend","dragstart","heading_changed","idle","maptypeid_changed","mousemove","mouseout","mouseover","projection_changed","resize","rightclick","tilesloaded","tilt_changed","zoom_changed"];n.forEach(t)}]).controller("MapCtrl",["$scope","$rootScope","$localStorage","MapSvc",function(e,t,r,n){r.$default({lat:0,lng:0,zoom:10,mapTypeId:n.MapTypeId.ROADMAP,style:[{stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"on"},{color:"#ffffff"}]},{featureType:"road",stylers:[{visibility:"on"}]},{elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#808080"}]},{elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{elementType:"labels.text.fill",stylers:[{color:"#000000"}]},{featureType:"water",stylers:[{visibility:"on"},{color:"#40bfbf"}]},{featureType:"water",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#dfdfdf"}]},{featureType:"road.local",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",stylers:[{visibility:"off"}]}]}),e.$on("map:idle",function(){var e=n.map.getCenter(),t=n.map.getZoom();r.lat=e.lat(),r.lng=e.lng(),r.zoom=t}),e.$on("map:maptypeid_changed",function(){var e=n.map.getMapTypeId();r.mapTypeId=e});var o={center:new n.LatLng(r.lat,r.lng),disableDefaultUI:!0,disableDoubleClickZoom:!0,draggableCursor:"crosshair",draggingCursor:"move",mapTypeId:r.mapTypeId,mapTypeControl:!0,mapTypeControlOptions:{mapTypeIds:[n.MapTypeId.ROADMAP,n.MapTypeId.HYBRID,"custom"]},scaleControl:!0,zoom:r.zoom};n.map.setOptions(o);var a=new n.StyledMapType(r.style,{name:"Custom"});n.map.mapTypes.set("custom",a)}]).controller("MapActionCtrl",["$scope","MapSvc",function(e,t){e.setMapTypeId=function(e){e in t.MapTypeId&&(console.log(e,"in MapSvc.mapTypeId"),e=t.MapTypeId[e]),t.map.setMapTypeId(e)}}]),angular.module("bndry.mode",[]).controller("ModeCtrl",["$scope",function(e){e.rigid=!1,e.polygon=!1}]),angular.module("bndry.search",["ngSanitize","bndry.map"]).directive("focusOn",["$parse",function(e){return{restrict:"A",link:function(t,r,n){var o=e(n.focusOn);t.$watch(o,function(e){void 0!==e&&(e?r[0].focus():r[0].blur())})}}}]).service("SearchSvc",["$q","MapSvc",function(e,t){this.search=function(r){var n=e.defer();if(r.length<=0)n.resolve([]);else{var o={input:r};o.bounds=t.map.getBounds(),t.autocompleteSvc.getPlacePredictions(o,function(e,r){r===t.places.PlacesServiceStatus.OK?n.resolve(e):n.reject(r===t.places.PlacesServiceStatus.ZERO_RESULTS?"No Results":"An Error Occurred")})}return n.promise},this.loadPlaceFromReference=function(e){e&&e&&t.placesSvc.getDetails({reference:e},function(e,r){r===t.places.PlacesServiceStatus.OK&&(e.geometry.viewport?t.map.fitBounds(e.geometry.viewport):e.geometry.location&&t.map.panTo(e.geometry.location))})}}]).controller("SearchCtrl",["$scope","$sce","$sessionStorage","SearchSvc",function(e,t,r,n){function o(e){if(e){if(!c)return void(l=e);s=e,c=!1,n.search(e).then(a,i).then(function(){c=!0,l!==s&&(o(l),l="")})}}function a(r){for(var n=0;n<r.length;n++){var o=r[n].description;r[n].description="";for(var a=0,i=0;i<r[n].matched_substrings.length;i++){var c=r[n].matched_substrings[i].offset,l=r[n].matched_substrings[i].length;r[n].description+=o.slice(a,c)+"<b>"+o.substr(c,l)+"</b>",a=c+l}r[n].description+=o.slice(a),r[n].description="<span>"+r[n].description+"</span>",r[n].description=t.trustAsHtml(r[n].description)}e.suggestions=r}function i(r){"string"==typeof r&&(e.suggestions=[{description:t.trustAsHtml("<i>"+r+"</i>"),error:!0}])}var c=!0,l="",s="";e.$tempStorage=r.$default({query:"",active:-1}),e.keydown=function(t){var r=13===t.which,n=38===t.which,o=40===t.which;return r||n||o?(t.preventDefault(),void(e.suggestions[e.$tempStorage.active]&&(r?(e.loadOnMap(e.suggestions[e.$tempStorage.active].reference),e.show.value=""):n&&e.$tempStorage.active>-1?e.$tempStorage.active--:o&&e.$tempStorage.active<e.suggestions.length-1&&e.$tempStorage.active++))):void(e.$tempStorage.active=0)},e.loadOnMap=n.loadPlaceFromReference,e.$watch("$tempStorage.query",o)}]),angular.module("bndry.status",["bndry.map","bndry.geo"]).directive("statusBar",["$interval",function(e){return{restrict:"E",scope:{hide:"@",value:"@"},template:'<div ng-style="{width: value * 100 + \'%\'}" style="height: 100%; position: absolute;" ng-hide="hide"></div>',link:function(t){e(function(){t.value=Math.random()},1e3)}}}]).controller("StatusCtrl",["$scope","$timeout","MapSvc","GeocodeSvc",function(e,t,r,n){var o="";e.locality=function(){return o},e.$on("map:idle",function(){n.geocode(r.map.getCenter()).then(function(e){var t=["administrative_area_level_3","administrative_area_level_2","administrative_area_level_1","country"];o="",e.forEach(function(e){if(!o)for(var r=0;r<t.length;r++)if(e.types.indexOf(t[r])>-1&&(o=e.formatted_address),o)return!1})},function(){o="Unknown Locality"})})}]),angular.module("bndry",["ngTouch","ngStorage","ui.map","ngAnimate","bndry.action","bndry.color","bndry.drawing","bndry.geo","bndry.history","bndry.image","bndry.map","bndry.mode","bndry.search","bndry.status"]).directive("noScroll",function(){return{restrict:"A",link:function(e,t){t.on("touchstart wheel",function(e){e.preventDefault()})}}}).controller("MasterCtrl",["$scope","$localStorage","ColorSvc",function(e,t,r){e.$storage=t,e.fillActiveColor=function(){var t=e.$storage.activeColor,n=e.$storage.colors[t],o=r.convert.rgba(n).to.hex24();return"#"+o},e.show={header:"",footer:""},e.setShowHeader=function(t){e.show.header=e.show.header===t?"":t},e.setShowFooter=function(t){e.show.footer=e.show.footer===t?"":t}}]).run(function(){window.addEventListener("orientationchange",function(){window.scrollTo(0,0)})});