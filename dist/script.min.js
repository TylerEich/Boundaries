/*
 Boundaries v1.0.0
 (c) 2013-2014 Tyler Eich https://github.com/TylerEich/Boundaries
 License: MIT
*/
"use strict";angular.module("bndry.action",[]).controller("ActionCtrl",["$rootScope","$scope","HistorySvc",function(e,t,n){t.clear=function(){e.$broadcast("action:clear"),n.clear()},t.undo=function(){n.hasUndo()&&n.undo()},t.redo=function(){n.hasRedo()&&n.redo()}}]),angular.module("bndry.color",[]).service("ColorSvc",function(){function e(){for(var e=1,t=0,n=arguments.length;n>e;e++)arguments[t]>arguments[e]&&(t=e);return arguments[t]}function t(){for(var e=1,t=0,n=arguments.length;n>e;e++)arguments[e]>arguments[t]&&(t=e);return arguments[t]}function n(e,t,n,r){return e=Math.round(255*e),t=Math.round(255*t),n=Math.round(255*n),r=Math.round(255*r),(e<<24|t<<16|n<<8|r)>>>0}var r={},o=this;this.convert={rgba:function(e){return r=n(e.r,e.g,e.b,e.a),o},hsla:function(e){var t,a=e,i=a.h,c=a.s,l=a.l,s=a.a;return i*=6,t=[l+=c*=.5>l?l:1-l,l-i%1*c*2,l-=c*=2,l,l+i%1*c,l+c],r=n(t[~~i%6],t[(16|i)%6],t[(8|i)%6],s),o},hex24:function(e){return o.convert.hex32(e+"FF"),o},hex32:function(e){return r=parseInt(e,16)>>>0,o}},this.to={rgba:function(){var e=(r>>24&255)/255,t=(r>>16&255)/255,n=(r>>8&255)/255,o=(255&r)/255;return r=0,{r:e,g:t,b:n,a:o}},hsla:function(){var n,r,a,i=o.to.rgba(),c=i,l=c.r,s=c.g,u=c.b,d=c.a,g=e(l,s,u),p=t(l,s,u),f=p-g;return n=r=a=(p+g)/2,p===g?n=r=0:(n=l===p?(s-u)/f%6:s===p?(u-l)/f+2:(l-s)/f+4,n/=6),{h:n,s:r,l:a,a:d}},hex24:function(){return o.to.hex32().substring(0,6)},hex32:function(){var e=r.toString(16);return r=0,("00000000"+e).slice(-8)}}}).controller("ColorCtrl",["$scope","$localStorage","ColorSvc",function(e,t,n){e.$storage=t.$default({colors:[{r:1,g:0,b:0,a:.125,weight:10},{r:0,g:1,b:0,a:.125,weight:10},{r:0,g:0,b:1,a:.125,weight:10}],activeColor:1}),e.fillColor=function(t){var r=e.$storage.colors[t];return"#"+n.convert.rgba(r).to.hex24()}}]),angular.module("bndry.drawing",["ngStorage","bndry.map","bndry.color","bndry.history"]).service("DirectionsSvc",["$q","MapSvc",function(e,t){var n=this,r=new t.DirectionsService;n.route=function(n){function o(e){r.route(a,function(n,r){if(r===t.DirectionsStatus.OK){var a=n.routes[0].overview_path;i.resolve(a)}else r===t.DirectionsStatus.UNKNOWN_ERROR&&3>e?(e++,o(e)):i.reject()},function(){3>e?(e++,o(e)):i.reject()})}if(2!==n.length)return console.error("Requires exactly 2 locations."),!1;var a={origin:n[0],destination:n[1],travelMode:t.TravelMode.DRIVING},i=e.defer();return o(0),i.promise}}]).service("DrawingSvc",["$rootScope","$q","$localStorage","DirectionsSvc","MapSvc","ColorSvc",function(e,t,n,r,o,a){function i(e){return"rgba("+100*e.r+"%,"+100*e.g+"%,"+100*e.b+"%,"+e.a+")"}function c(e,t,n){for(var r=d.drawings[e],o=t;o<r.nodes.length;o++){var a=r.nodes[o];a.index+=n}}function l(e){return{path:o.SymbolPath.CIRCLE,scale:10,strokeColor:"#"+a.convert.rgba(e).to.hex24(),strokeOpacity:1,strokeWeight:2.5}}function s(e,t){return{clickable:!0,crossOnDrag:!1,cursor:"pointer",draggable:!0,flat:!0,icon:l(e),map:o.map,position:t}}function u(e,t){var n={clickable:!0,draggable:!1,editable:!1,map:o.map};return t?(n.fillColor=i(e),n.strokeWeight=0):(n.strokeColor=i(e),n.strokeWeight=e.weight),n}var d=this;d.makePath=function(e,n){var o=t.defer();return n?o.resolve(e):r.route(e).then(o.resolve),o.promise},d.splicePath=function(e,t,n,r){var o=[t,n];return r&&(o=o.concat(r)),Array.prototype.splice.apply(e,o)},d.makeNode=function(e,t){var r=n.colors[e],a=new o.Marker(s(r,t));return{lat:t.lat(),lng:t.lng(),index:null,_marker:a}},d.spliceNode=function(e,n,r,a){void 0===r&&(r=d.drawings[e].nodes.length);var i=d.drawings[e],l=[n,r];a&&(a._marker.setMap(o.map),l=l.concat(a));var s,u,g,p=Array.prototype.splice.apply(i.nodes,l);if(u=i.nodes[n],n>=1&&n-1<i.nodes.length&&(s=i.nodes[n-1]),n>=0&&n+1<i.nodes.length&&(g=i.nodes[n+1]),p.length>0){var f=i._poly,h=f.getPath().getArray(),v=(s?s.index:-1)+1,m=g?g.index:p[p.length-1].index+1,y=m-v;d.splicePath(h,v,y),f.setPath(h),u&&(u.index=s?s.index:0),c(e,n+1,-y)}for(var b=0;b<p.length;b++)p[b]._marker.setMap(null);var w,S,$,T,M=[];u&&(S=new o.LatLng(u.lat,u.lng),s&&($=new o.LatLng(s.lat,s.lng),w=d.makePath([$,S],i.rigid).then(function(e){return u.index=s.index,e}),M.push(w)),g&&(T=new o.LatLng(g.lat,g.lng),M.push(d.makePath([S,T],i.rigid))),s||g||M.push(d.makePath([S,S],i.rigid)),t.all(M).then(function(t){var r,o,l,u,p=i._poly.getPath().getArray(),f=0;2===t.length&&t[1].shift(),s?(o=t[0],o.shift(),c(e,n,o.length),f=s.index+1,u=o[o.length-1]):a.index=0,g&&(l=t[t.length-1],l.pop(),c(e,n+1,l.length),u=u||l[0]),s||g||(u=t[0][0]),r=Array.prototype.concat.apply([],t),d.splicePath(p,f,0,r),a._marker.setPosition(u),i._poly.setPath(p)}))},d.makeDrawing=function(e,t,r){var a,i=n.colors[e];return a=r?new o.Polygon(u(i,r)):new o.Polyline(u(i,r)),{colorIndex:e,rigid:t,fill:r,_poly:a,nodes:[]}},d.spliceDrawing=function(e,t,n){void 0===t&&(t=d.drawings.length);var r=d.drawings.slice(e,e+t);for(var o in r)r[o]._poly.setMap(null),d.spliceNode(o,0);var a=[e,t];n&&a.push(n),Array.prototype.splice.apply(d.drawings,a)},d.drawings=[]}]).controller("DrawingCtrl",["$scope","$localStorage","DrawingSvc","HistorySvc",function(e,t,n,r){function o(t,o){var a=e.$storage.activeColor,c=!1,l=!1,s=i();if(s){var u=n.makeDrawing(a,c,l);n.spliceDrawing(n.drawings.length,0,u)}var d=n.drawings.length-1,g=n.drawings[d].nodes.length,p=n.makeNode(a,o.latLng);n.spliceNode(d,g,0,p),r.add({undo:function(e,t,r){n.spliceNode(e,t,1),r&&n.spliceDrawing(e,1)}.bind(null,d,g,s),redo:function(e,t,r){n.spliceNode(e,t,0,r)}.bind(null,d,g,p)})}function a(e,t,o){var a=e[0],i=n.drawings[t].colorIndex,c=n.drawings[t].nodes[o],l=n.makeNode(i,a.latLng);n.spliceNode(t,o,1,l),r.add({undo:function(e,t,r){n.spliceNode(e,t,1,r)}.bind(null,t,o,c),redo:function(e,t,r){n.spliceNode(e,t,1,r)}.bind(null,t,o,l)})}function i(){if(0===n.drawings.length)return!0;var t=n.drawings[n.drawings.length-1];return t&&t.colorIndex!==e.$storage.activeColor}e.$storage=t.$default({rigid:!1,colors:[{r:1,g:0,b:0,a:.125,weight:10},{r:0,g:1,b:0,a:.125,weight:10},{r:0,g:0,b:1,a:.125,weight:10}],activeColor:1}),e.drawings=n.drawings,e.$on("map:click",o),e.$on("action:clear",function(){n.spliceDrawing(0)}),e.marker={click:function(e){o(void 0,e[0])},dragend:a},e.poly={click:function(){}}}]),angular.module("bndry.geo",["bndry.map"]).service("GeolocationSvc",["$q",function(e){this.getLocation=function(){var t=e.defer();return"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){t.resolve(e)},function(e){t.reject(e)}):t.reject(!1),t.promise}}]).service("GeocodeSvc",["$q","MapSvc",function(e,t){this.geocode=function(n){var r=new t.Geocoder,o=e.defer();return r.geocode({location:n},function(e,n){n===t.GeocoderStatus.OK?o.resolve(e):o.reject(n)}),o.promise}}]),angular.module("bndry.history",[]).service("HistorySvc",function(){var e,t,n=[],r=-1,o=!1;return t=function(e,t){return e&&"function"==typeof e[t]?(o=!0,e[t](),o=!1,this):this},{add:function(t){return o?this:(n.splice(r+1,n.length-r),n.push(t),r=n.length-1,e&&e(),this)},setCallback:function(t){e=t},undo:function(){var o=n[r];return o?(t(o,"undo"),r-=1,e&&e(),this):this},redo:function(){var o=n[r+1];return o?(t(o,"redo"),r+=1,e&&e(),this):this},clear:function(){var t=n.length;n=[],r=-1,e&&t>0&&e()},hasUndo:function(){return-1!==r},hasRedo:function(){return r<n.length-1},getCommands:function(){return n}}}),angular.module("bndry.image",["ngStorage","bndry.map","bndry.drawing","bndry.color"]).service("ImageSvc",["$localStorage","MapSvc","DrawingSvc","ColorSvc",function(e,t,n,r){this.pxSize=function(t,n){var r=e.width/e.height;return{ratio:r,width:r>=1?t:Math.round(r*t),height:1>r?n:Math.round(1/r*n)}},this.generateUrl=function(){if(n.drawings){var o,a,i,c,l,s,u,d="https://maps.googleapis.com/maps/api/staticmap",g=[],p=this.pxSize(640,640);for(o=0;o<e.style.length;o++){i=e.style[o],c=[],"featureType"in i&&"all"!==i.featureType&&c.push("feature:"+i.featureType),"elementType"in i&&"all"!==i.elementType&&c.push("element:"+i.elementType);for(a=0;a<i.stylers.length;a++){l=i.stylers[a];for(s in l)u=l[s],"color"===s&&(u="0x"+u.substring(1)),c.push(s+":"+u)}c=c.join("|"),""!==c&&g.push("style="+c)}var f,h,v,m,y,b,w=new t.LatLngBounds;for(o=0;o<n.drawings.length;o++){for(h=[],f=n.drawings[o],v=f._poly.getPath().getArray(),a=0;a<v.length;a++)w.extend(v[a]);m=t.geometry.encoding.encodePath(v),y=e.colors[f.activeColor],b="0x"+r.convert.hex24().toHex(y.rgba),f.polygon?h.push("fillcolor:"+b):(h.push("color:"+b),h.push("weight:"+y.weight)),h.push("enc:"+m),h=h.join("|"),h&&g.push("path="+h)}var S=w.getNorthEast(),$=w.getSouthWest(),T=Math.abs(t.computeHeading(S,$)+t.computeHeading(t.southWest,S))/2;return g.push((T>=45&&135>T)==p.ratio>=1?"size="+p.height+"x"+p.width:"size="+p.width+"x"+p.height),g.push("format="+e.format),g.push("scale=2"),g.push("sensor=true"),encodeURI(d+"?"+g.join("&"))}}}]),angular.module("bndry.map",["ngStorage"]).service("MapSvc",["$rootScope",function(e){function t(t){n.map.addListener(t,function(n){e.$broadcast("map:"+t,n)})}var n=this;angular.extend(n,google.maps),n.map=new n.Map(document.getElementById("map_canvas")),n.placesSvc=new n.places.PlacesService(n.map),n.autocompleteSvc=new n.places.AutocompleteService;var r=["bounds_changed","center_changed","click","dblclick","drag","dragend","dragstart","heading_changed","idle","maptypeid_changed","mousemove","mouseout","mouseover","projection_changed","resize","rightclick","tilesloaded","tilt_changed","zoom_changed"];r.forEach(t)}]).controller("MapCtrl",["$scope","$rootScope","$localStorage","MapSvc",function(e,t,n,r){n.$default({lat:0,lng:0,zoom:10,mapTypeId:r.MapTypeId.ROADMAP,style:[{stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{visibility:"on"},{color:"#ffffff"}]},{featureType:"road",stylers:[{visibility:"on"}]},{elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#808080"}]},{elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{elementType:"labels.text.fill",stylers:[{color:"#000000"}]},{featureType:"water",stylers:[{visibility:"on"},{color:"#40bfbf"}]},{featureType:"water",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#dfdfdf"}]},{featureType:"road.local",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",stylers:[{visibility:"off"}]}]}),e.$on("map:idle",function(){var e=r.map.getCenter(),t=r.map.getZoom();n.lat=e.lat(),n.lng=e.lng(),n.zoom=t}),e.$on("map:maptypeid_changed",function(){var e=r.map.getMapTypeId();n.mapTypeId=e});var o={center:new r.LatLng(n.lat,n.lng),disableDefaultUI:!0,disableDoubleClickZoom:!0,draggableCursor:"crosshair",draggingCursor:"move",mapTypeId:n.mapTypeId,mapTypeControl:!0,mapTypeControlOptions:{mapTypeIds:[r.MapTypeId.ROADMAP,r.MapTypeId.HYBRID,"custom"]},scaleControl:!0,zoom:n.zoom};r.map.setOptions(o);var a=new r.StyledMapType(n.style,{name:"Custom"});r.map.mapTypes.set("custom",a)}]).controller("MapActionCtrl",["$scope","MapSvc",function(e,t){e.setMapTypeId=function(e){e in t.MapTypeId&&(console.log(e,"in MapSvc.mapTypeId"),e=t.MapTypeId[e]),t.map.setMapTypeId(e)}}]),angular.module("bndry.mode",[]).controller("ModeCtrl",["$scope",function(e){e.rigid=!1,e.polygon=!1}]),angular.module("bndry.search",["ngSanitize","bndry.map"]).directive("focusOn",["$parse",function(e){return{restrict:"A",link:function(t,n,r){var o=e(r.focusOn);t.$watch(o,function(e){void 0!==e&&(e?n[0].focus():n[0].blur())})}}}]).service("SearchSvc",["$q","MapSvc",function(e,t){this.search=function(n){var r=e.defer();if(n.length<=0)r.resolve([]);else{var o={input:n};o.bounds=t.map.getBounds(),t.autocompleteSvc.getPlacePredictions(o,function(e,n){n===t.places.PlacesServiceStatus.OK?r.resolve(e):r.reject(n===t.places.PlacesServiceStatus.ZERO_RESULTS?"No Results":"An Error Occurred")})}return r.promise},this.loadPlaceFromReference=function(e){e&&e&&t.placesSvc.getDetails({reference:e},function(e,n){n===t.places.PlacesServiceStatus.OK&&(e.geometry.viewport?t.map.fitBounds(e.geometry.viewport):e.geometry.location&&t.map.panTo(e.geometry.location))})}}]).controller("SearchCtrl",["$scope","$sce","$sessionStorage","SearchSvc",function(e,t,n,r){function o(e){if(e){if(!c)return void(l=e);s=e,c=!1,r.search(e).then(a,i).then(function(){c=!0,l!==s&&(o(l),l="")})}}function a(n){for(var r=0;r<n.length;r++){var o=n[r].description;n[r].description="";for(var a=0,i=0;i<n[r].matched_substrings.length;i++){var c=n[r].matched_substrings[i].offset,l=n[r].matched_substrings[i].length;n[r].description+=o.slice(a,c)+"<b>"+o.substr(c,l)+"</b>",a=c+l}n[r].description+=o.slice(a),n[r].description="<span>"+n[r].description+"</span>",n[r].description=t.trustAsHtml(n[r].description)}e.suggestions=n}function i(n){"string"==typeof n&&(e.suggestions=[{description:t.trustAsHtml("<i>"+n+"</i>"),error:!0}])}var c=!0,l="",s="";e.$tempStorage=n.$default({query:"",active:-1}),e.keydown=function(t){var n=13===t.which,r=38===t.which,o=40===t.which;return n||r||o?(t.preventDefault(),void(e.suggestions[e.$tempStorage.active]&&(n?(e.loadOnMap(e.suggestions[e.$tempStorage.active].reference),e.show.value=""):r&&e.$tempStorage.active>-1?e.$tempStorage.active--:o&&e.$tempStorage.active<e.suggestions.length-1&&e.$tempStorage.active++))):void(e.$tempStorage.active=0)},e.loadOnMap=r.loadPlaceFromReference,e.$watch("$tempStorage.query",o)}]),angular.module("bndry.status",["bndry.map","bndry.geo"]).directive("statusBar",["$interval",function(e){return{restrict:"E",scope:{hide:"@",value:"@"},template:'<div ng-style="{width: value * 100 + \'%\'}" style="height: 100%; position: absolute;" ng-hide="hide"></div>',link:function(t){e(function(){t.value=Math.random()},1e3)}}}]).controller("StatusCtrl",["$scope","$timeout","MapSvc","GeocodeSvc",function(e,t,n,r){var o="";e.locality=function(){return o},e.$on("map:idle",function(){r.geocode(n.map.getCenter()).then(function(e){var t=["administrative_area_level_3","administrative_area_level_2","administrative_area_level_1","country"];o="",e.forEach(function(e){if(!o)for(var n=0;n<t.length;n++)if(e.types.indexOf(t[n])>-1&&(o=e.formatted_address),o)return!1})},function(){o="Unknown Locality"})})}]),angular.module("bndry",["ngTouch","ngStorage","ui.map","ngAnimate","bndry.action","bndry.color","bndry.drawing","bndry.geo","bndry.history","bndry.image","bndry.map","bndry.mode","bndry.search","bndry.status"]).directive("noScroll",function(){return{restrict:"A",link:function(e,t){t.on("touchstart wheel",function(e){e.preventDefault()})}}}).controller("MasterCtrl",["$scope","$localStorage","ColorSvc",function(e,t,n){e.$storage=t,e.fillActiveColor=function(){var t=e.$storage.activeColor,r=e.$storage.colors[t],o=n.convert.rgba(r).to.hex24();return"#"+o},e.show={header:"",footer:""},e.setShowHeader=function(t){e.show.header=e.show.header===t?"":t},e.setShowFooter=function(t){e.show.footer=e.show.footer===t?"":t}}]).run(function(){window.addEventListener("DOMContentLoaded",function(){angular.element(document.querySelector("#splash")).removeClass("loading")},!1),window.addEventListener("orientationchange",function(){window.scrollTo(0,0)})});